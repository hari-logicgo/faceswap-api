<!DOCTYPE html>
<html>
<head>
    <title>FaceSwap API Test</title>
</head>
<body>
    <h2>Test FaceSwap API</h2>

    <button onclick="testHealth()">Test Health</button>
    <button onclick="getTargetImages()">Get Target Images</button>

    <h3>Upload Source Image</h3>
    <input type="file" id="sourceImage">
    <button onclick="uploadSource()">Upload</button>

    <h3>Select Target Image</h3>
    <select id="targetSelect"></select>

    <h3>Face Swap</h3>
    <button onclick="faceSwap()">Swap Faces</button>

    <h3>Swapped Result</h3>
    <img id="swappedImg" src="" alt="Swapped Face" style="max-width:400px; display:block;">
    <div id="result"></div>

    <script>
        const BASE_URL = 'https://faceswap-api-fqoz.onrender.com';
        let uploadedSourceId = null;

        async function testHealth() {
            const res = await fetch(`${BASE_URL}/api/health`);
            const data = await res.json();
            showResult('Health: ' + JSON.stringify(data));
        }

        async function getTargetImages() {
            const res = await fetch(`${BASE_URL}/api/target-images`);
            const data = await res.json();
            const select = document.getElementById('targetSelect');
            select.innerHTML = '';
            data.forEach(img => {
                const opt = document.createElement('option');
                opt.value = img.id;
                opt.text = `${img.filename} (ID: ${img.id})`;
                select.appendChild(opt);
            });
            showResult('Target images loaded');
        }

        async function uploadSource() {
            const fileInput = document.getElementById('sourceImage');
            if (!fileInput.files[0]) return showResult('Please select a file');

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const res = await fetch(`${BASE_URL}/api/upload/source`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            uploadedSourceId = data.id;
            showResult('Source uploaded: ' + JSON.stringify(data));
        }

        async function faceSwap() {
            if (!uploadedSourceId) return showResult('Upload a source image first');
            const targetId = document.getElementById('targetSelect').value;
            if (!targetId) return showResult('Select a target image');

            const res = await fetch(`${BASE_URL}/api/faceswap`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    source_image_id: uploadedSourceId,
                    target_image_id: targetId
                })
            });

            if (!res.ok) {
                const err = await res.json();
                return showResult('Face Swap Error: ' + JSON.stringify(err));
            }

            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            document.getElementById('swappedImg').src = url;
            showResult('Face swap successful!');
        }

        function showResult(msg) {
            document.getElementById('result').innerText = msg;
        }

        // Load target images on page load
        window.onload = getTargetImages;
    </script>
</body>
</html>
